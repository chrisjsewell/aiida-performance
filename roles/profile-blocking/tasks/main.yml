- name: "Run pre-test script: {{ TEST_NAME }}"
  command: >
    docker exec --user aiida aiida-core verdi run tests/{{ TEST_NAME }}.py --pre

- name: "Reset database stats"
  command:
    cmd: >
      docker exec --user aiida aiida-core verdi run tests/db_stats.py reset
  changed_when: False

- name: "Run test script: {{ TEST_NAME }}"
  command:
    cmd: >
      docker exec --user aiida aiida-core /usr/bin/time -f "{{ TEST_NAME }}: %e" -o /home/aiida/outputs/run_times.yml -a --quiet
      py-spy record --subprocesses -f raw -o /home/aiida/outputs/{{ TEST_NAME }}.prof --
      verdi run tests/{{ TEST_NAME }}.py
    creates: outputs/{{ OUTPUT_FOLDER }}/{{ TEST_NAME }}.prof
    # TODO on exit raises Error: No child process (os error 10)
  ignore_errors: yes
  register: test_output

- name: "Convert profile output to SVG: {{ TEST_NAME }}"
  shell:
    cmd: > 
      docker run --rm --name flamegraph
      -v "$PWD/plotting":/usr/src/myapp/plotting -v "$PWD/outputs/{{ OUTPUT_FOLDER }}":/usr/src/myapp/outputs
      -w /usr/src/myapp perl:5.20
      perl plotting/flamegraph.pl --inverted --title {{ TEST_NAME }} outputs/{{ TEST_NAME }}.prof
      > outputs/{{ OUTPUT_FOLDER }}/{{ TEST_NAME }}.svg
    creates: outputs/{{ OUTPUT_FOLDER }}/{{ TEST_NAME }}.svg

- name: "Dump database query stats: {{ TEST_NAME }}"
  when: test_output.changed
  command:
    cmd: >
      docker exec --user aiida aiida-core verdi run tests/db_stats.py --path "/home/aiida/outputs" --name "{{ TEST_NAME }}" queries reset
    creates: outputs/{{ OUTPUT_FOLDER }}/{{ TEST_NAME }}_queries.html
